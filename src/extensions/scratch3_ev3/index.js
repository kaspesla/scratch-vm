const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
const formatMessage = require('format-message');
const uid = require('../../util/uid');
const BT = require('../../io/bt');
const Base64Util = require('../../util/base64-util');
const MathUtil = require('../../util/math-util');
const RateLimiter = require('../../util/rateLimiter.js');
const log = require('../../util/log');

/**
 * Icon svg to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
const blockIconURI = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNDBweCIgaGVpZ2h0PSI0MHB4IiB2aWV3Qm94PSIwIDAgNDAgNDAiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUwLjIgKDU1MDQ3KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5ldjMtYmxvY2staWNvbjwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSJldjMtYmxvY2staWNvbiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9ImV2MyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNS41MDAwMDAsIDMuNTAwMDAwKSIgZmlsbC1ydWxlPSJub256ZXJvIj4KICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS1wYXRoIiBzdHJva2U9IiM3Qzg3QTUiIGZpbGw9IiNGRkZGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgeD0iMC41IiB5PSIzLjU5IiB3aWR0aD0iMjgiIGhlaWdodD0iMjUuODEiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgc3Ryb2tlPSIjN0M4N0E1IiBmaWxsPSIjRTZFN0U4IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjIuNSIgeT0iMC41IiB3aWR0aD0iMjQiIGhlaWdodD0iMzIiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgc3Ryb2tlPSIjN0M4N0E1IiBmaWxsPSIjRkZGRkZGIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHg9IjIuNSIgeT0iMTQuNSIgd2lkdGg9IjI0IiBoZWlnaHQ9IjEzIj48L3JlY3Q+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0xNC41LDEwLjUgTDE0LjUsMTQuNSIgaWQ9IlNoYXBlIiBzdHJva2U9IiM3Qzg3QTUiIGZpbGw9IiNFNkU3RTgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PC9wYXRoPgogICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLXBhdGgiIGZpbGw9IiM0MTQ3NTciIHg9IjQuNSIgeT0iMi41IiB3aWR0aD0iMjAiIGhlaWdodD0iMTAiIHJ4PSIxIj48L3JlY3Q+CiAgICAgICAgICAgIDxyZWN0IGlkPSJSZWN0YW5nbGUtcGF0aCIgZmlsbD0iIzdDODdBNSIgb3BhY2l0eT0iMC41IiB4PSIxMy41IiB5PSIyMC4xMyIgd2lkdGg9IjIiIGhlaWdodD0iMiIgcng9IjAuNSI+PC9yZWN0PgogICAgICAgICAgICA8cGF0aCBkPSJNOS4wNiwyMC4xMyBMMTAuNTYsMjAuMTMgQzEwLjgzNjE0MjQsMjAuMTMgMTEuMDYsMjAuMzUzODU3NiAxMS4wNiwyMC42MyBMMTEuMDYsMjEuNjMgQzExLjA2LDIxLjkwNjE0MjQgMTAuODM2MTQyNCwyMi4xMyAxMC41NiwyMi4xMyBMOS4wNiwyMi4xMyBDOC41MDc3MTUyNSwyMi4xMyA4LjA2LDIxLjY4MjI4NDcgOC4wNiwyMS4xMyBDOC4wNiwyMC41Nzc3MTUzIDguNTA3NzE1MjUsMjAuMTMgOS4wNiwyMC4xMyBaIiBpZD0iU2hhcGUiIGZpbGw9IiM3Qzg3QTUiIG9wYWNpdHk9IjAuNSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMTguOTEsMjAuMTMgTDIwLjQyLDIwLjEzIEMyMC42OTYxNDI0LDIwLjEzIDIwLjkyLDIwLjM1Mzg1NzYgMjAuOTIsMjAuNjMgTDIwLjkyLDIxLjYzIEMyMC45MiwyMS45MDYxNDI0IDIwLjY5NjE0MjQsMjIuMTMgMjAuNDIsMjIuMTMgTDE4LjkyLDIyLjEzIEMxOC4zNjc3MTUzLDIyLjEzIDE3LjkyLDIxLjY4MjI4NDcgMTcuOTIsMjEuMTMgQzE3LjkxOTk3MjYsMjAuNTgxNTk3IDE4LjM2MTYyNDUsMjAuMTM1NDg0IDE4LjkxLDIwLjEzIFoiIGlkPSJTaGFwZSIgZmlsbD0iIzdDODdBNSIgb3BhY2l0eT0iMC41IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxOS40MjAwMDAsIDIxLjEzMDAwMCkgcm90YXRlKC0xODAuMDAwMDAwKSB0cmFuc2xhdGUoLTE5LjQyMDAwMCwgLTIxLjEzMDAwMCkgIj48L3BhdGg+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik04LjIzLDE3LjUgTDUsMTcuNSBDNC43MjM4NTc2MywxNy41IDQuNSwxNy4yNzYxNDI0IDQuNSwxNyBMNC41LDE0LjUgTDEwLjUsMTQuNSBMOC42NSwxNy4yOCBDOC41NTQ2Njk2MSwxNy40MTc5MDgyIDguMzk3NjUwMDYsMTcuNTAwMTU2NiA4LjIzLDE3LjUgWiIgaWQ9IlNoYXBlIiBmaWxsPSIjN0M4N0E1IiBvcGFjaXR5PSIwLjUiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTE4LjE1LDE4Ljg1IEwxNy42NSwxOS4zNSBDMTcuNTUyMzQxNiwxOS40NDQwNzU2IDE3LjQ5ODAzMzksMTkuNTc0NDE0MiAxNy41LDE5LjcxIEwxNy41LDIwIEMxNy41LDIwLjI3NjE0MjQgMTcuMjc2MTQyNCwyMC41IDE3LDIwLjUgTDE2LjUsMjAuNSBDMTYuMjIzODU3NiwyMC41IDE2LDIwLjI3NjE0MjQgMTYsMjAgQzE2LDE5LjcyMzg1NzYgMTUuNzc2MTQyNCwxOS41IDE1LjUsMTkuNSBMMTMuNSwxOS41IEMxMy4yMjM4NTc2LDE5LjUgMTMsMTkuNzIzODU3NiAxMywyMCBDMTMsMjAuMjc2MTQyNCAxMi43NzYxNDI0LDIwLjUgMTIuNSwyMC41IEwxMiwyMC41IEMxMS43MjM4NTc2LDIwLjUgMTEuNSwyMC4yNzYxNDI0IDExLjUsMjAgTDExLjUsMTkuNzEgQzExLjUwMTk2NjEsMTkuNTc0NDE0MiAxMS40NDc2NTg0LDE5LjQ0NDA3NTYgMTEuMzUsMTkuMzUgTDEwLjg1LDE4Ljg1IEMxMC42NTgyMTY3LDE4LjY1MjE4NjMgMTAuNjU4MjE2NywxOC4zMzc4MTM3IDEwLjg1LDE4LjE0IEwxMi4zNiwxNi42NSBDMTIuNDUwMjgwMywxNi41NTI4NjE3IDEyLjU3NzM5NjEsMTYuNDk4MzgzNSAxMi43MSwxNi41IEwxNi4yOSwxNi41IEMxNi40MjI2MDM5LDE2LjQ5ODM4MzUgMTYuNTQ5NzE5NywxNi41NTI4NjE3IDE2LjY0LDE2LjY1IEwxOC4xNSwxOC4xNCBDMTguMzQxNzgzMywxOC4zMzc4MTM3IDE4LjM0MTc4MzMsMTguNjUyMTg2MyAxOC4xNSwxOC44NSBaIiBpZD0iU2hhcGUiIGZpbGw9IiM3Qzg3QTUiIG9wYWNpdHk9IjAuNSI+PC9wYXRoPgogICAgICAgICAgICA8cGF0aCBkPSJNMTAuODUsMjMuNDUgTDExLjM1LDIyLjk1IEMxMS40NDc2NTg0LDIyLjg1NTkyNDQgMTEuNTAxOTY2MSwyMi43MjU1ODU4IDExLjUsMjIuNTkgTDExLjUsMjIuMyBDMTEuNSwyMi4wMjM4NTc2IDExLjcyMzg1NzYsMjEuOCAxMiwyMS44IEwxMi41LDIxLjggQzEyLjc3NjE0MjQsMjEuOCAxMywyMi4wMjM4NTc2IDEzLDIyLjMgQzEzLDIyLjU3NjE0MjQgMTMuMjIzODU3NiwyMi44IDEzLjUsMjIuOCBMMTUuNSwyMi44IEMxNS43NzYxNDI0LDIyLjggMTYsMjIuNTc2MTQyNCAxNiwyMi4zIEMxNiwyMi4wMjM4NTc2IDE2LjIyMzg1NzYsMjEuOCAxNi41LDIxLjggTDE3LDIxLjggQzE3LjI3NjE0MjQsMjEuOCAxNy41LDIyLjAyMzg1NzYgMTcuNSwyMi4zIEwxNy41LDIyLjU5IEMxNy40OTgwMzM5LDIyLjcyNTU4NTggMTcuNTUyMzQxNiwyMi44NTU5MjQ0IDE3LjY1LDIyLjk1IEwxOC4xNSwyMy40NSBDMTguMzQwNTcxNCwyMy42NDQ0MjE4IDE4LjM0MDU3MTQsMjMuOTU1NTc4MiAxOC4xNSwyNC4xNSBMMTYuNjQsMjUuNjUgQzE2LjU0OTcxOTcsMjUuNzQ3MTM4MyAxNi40MjI2MDM5LDI1LjgwMTYxNjUgMTYuMjksMjUuOCBMMTIuNzEsMjUuOCBDMTIuNTc3Mzk2MSwyNS44MDE2MTY1IDEyLjQ1MDI4MDMsMjUuNzQ3MTM4MyAxMi4zNiwyNS42NSBMMTAuODUsMjQuMTUgQzEwLjY1OTQyODYsMjMuOTU1NTc4MiAxMC42NTk0Mjg2LDIzLjY0NDQyMTggMTAuODUsMjMuNDUgWiIgaWQ9IlNoYXBlIiBmaWxsPSIjN0M4N0E1IiBvcGFjaXR5PSIwLjUiPjwvcGF0aD4KICAgICAgICAgICAgPHBhdGggZD0iTTIxLjUsMjcuNSBMMjYuNSwyNy41IEwyNi41LDMxLjUgQzI2LjUsMzIuMDUyMjg0NyAyNi4wNTIyODQ3LDMyLjUgMjUuNSwzMi41IEwyMS41LDMyLjUgTDIxLjUsMjcuNSBaIiBpZD0iU2hhcGUiIHN0cm9rZT0iI0NDNEMyMyIgZmlsbD0iI0YxNUEyOSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48L3BhdGg+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4=';

const cwIconURI =
  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAYAAAB5fY51AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAhGVYSWZNTQAqAAAACAAFARIAAwAAAAEAAQAAARoABQAAAAEAAABKARsABQAAAAEAAABSASgAAwAAAAEAAgAAh2kABAAAAAEAAABaAAAAAAAAAEgAAAABAAAASAAAAAEAA6ABAAMAAAABAAEAAKACAAQAAAABAAABLKADAAQAAAABAAABLAAAAAArWu/kAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgpMwidZAAAyVElEQVR4Ae2dCdBsR3meYxaxSSwSqyTEJplNMouEESYgJJstBjsJYbONDaESylVJHFLBsR3HWAXBkBDHwXFiMBYWrrIrVCjArMIICxDG7MZgEFJAV2JxzCJ2kGRneZ97+r2379H8//3nnz4z55x5v6rvdPeZme6v3/6+93T3nDlz478TCQKrIXBjffz/SZ8qPU16mZRzkSDQHIEbNa8xFW4bAt9XOnxHpa+TPln6f6Sc92vKRoLA6giEsFbHMDV0CFxbgHiN0p+T/l8pM6/4mECIBIEgMA4EblLMeI5SCIrZFelLpJYsEY1E0iAQBDaKQJ+w/kbWmLQurCwLaVVgJLs/BDJd3x9u+dTOCOBT7F1BWj8tvUh6bCmb3FSMBIHlEQhhLY9ZPnF0BCAsZlR/K32M9F3Sk0o5pCUgIvtDIIS1P9zyqb0hADmxRHyw9FLpGVJILKQlECLLIxDCWh6zfGI5BG6qt0NSd5e+W3qelHL2tARCZDkEQljL4ZV37w8BZlSQ1G2l7Gk9XcoeF/7H8jESBPaEQAhrTzDlTQ0QgLQgKdI/kP5Lae7VEgiRvSMQwto7Vnnn6giwDISkkP8sffHBXHcuS8QCRpIgEASGQ8Ab6P0bR7l5dCeFtOp7tXzhdF3DWZuaJ42AHWXSnYjxk0OAfSvU92q9RXnu1co3iAIhsjMCIaydsckrwyIAYflerccq/25p7tUaFvPJ1x7CmvwQTr4DLAOZWT1I+l7p6aWc5aGAiByJQAjrSDxS2gwCJq27qflLpedKvTxkJhYJAgcRCGHFEcaCgEnrNjLo7VLu1YK0IKyQlkCI5FlF8YFxIQBp1fdqPVfl3Ks1rjHaqDWZYW0U/jS+AIH6Xq1f1+v/obwH4sq9WgsA26ZTIaxtGu3p9BW/hKDQ50kvlLIsZPYV0hII2yohrG0d+fH3G980Sf208m+VHif1klHZyLYhEMLathGfVn8hrPperUtUPlnKZjxPgYhsGQIhrC0b8Il2198g1s/V4jlbnI9sEQIhrC0a7Il31aTFvVrvkZ4rZabFDIyZWGQLEAhhbcEgz6iLvu2Be7X+WPo0KXtaEFZISyDMXUJYcx/h+fWPGZW/LfxD5fNcrfmN8Y49CmHtCE1eGDECkBa3PCA8V8v/gcg5XovMFIEQ1kwHdgu6he/yvC1I6uelr5Yinn11pRxnhUAIa1bDuXWd8d4VJPUMaf4DceYuEMKa+QBvQfcgLZaBfGPo/0D0vVq57WFmDhDCmtmAbnF3IKf6PxB/QGVILKQ1I6cIYc1oMNOVg3e/Q1Lcq/Uu6XnSkJZAmIuEsOYykpvph/eQaJ38GMT3avEfiPVztfD1sdg4BpwmaUOmy5MctkGNroPa+X6KAXxDZ6XMxvdYpL5Xi/9AvJP0N4pxEJdviSinkgSBIDAFBCAiApgLFz8m3s+M2z9C5gZOCAziMpFtOq1t8X8gyrzcqwUIUxRfOadoe2zeOwKMs5VPQSQ7zTIgLf5y6+ZSfgJzovTOJb2L0hOkvH5L6S1KCmnxjze8Tt1j8iuTJv36fenPFBshafa3IhNCYEyONSHYRm+qycnpToHJUume0nsUvXspn6IUkoKY5iAmaJaK7Gs9SfptaUhLIExJQlhTGq3dbWUsCUiCc9F+konp/nr9LCmPamH2dCvpMdKdhPoQ0jrPudp/mMHUZV4fm/gbw4/KsCdKvyANaY1tlHaxZ+wOtovpW/8SYwdJIH2CYrnGLOlh0nOlkNTJ0jtKFwnLQy8RqbfWRe+f8jmT1tXqxBOkH5eGtCYyojhmZDoIMF47kdT367VHSs+Wnil9gLQ/viamRYTUf68+PlsxaX1dPWR5+E4ppOVNemUjQSAI7AcBkxQBVQvlR0j/nfT90mulXrY5JTCtBCOE5de2PeWueDAAn6dLkSksaztLcwwCI0OA4OmTFH/C8Gjpb0o/KfWMwORDmUDsn/frSY8kbMjKmPwr5S2exbqcNAgEgQUIMJti47wOGMoPlfLcp8ukDjCnJqjMnm6IjTHaLa3J3f+BKJhzrxYgRILAIgQgqv5s6r469wvSD0jrgMsS70g8amz2m4fsTVwXKu8LBheLSBAIAgUBAqMOCm4v4JurN0i/I60DEKJyUNXnkz8Sp/3iAWl5ifg25Vl+I/0LSXc2xyCwRQj0l33cJc4/HH9MWgecl3v1ueSPxKg1HmBOnR+Rcp8aUl9UujM5BoGZI7Bof+qB6vMrpF+TOvCYRXGlz57UYUyMzbpSk9ZfaRy4wRbxMrEr5bgRBDLdXQ/sXKEhIhR5uPSfS7kHyGPg13I1FygjkXrMRmJSzAgCwyHQX/o9Rk29RVrPFLiaZzZ1JCY1PuvOe3b1QY3LnaVILiIdDjnOFIH+Zvp56ufF0jr4suw7Eo8am03k6033N2us/MPvkNVMgzTd6n4K4yUeePATmddKHYAsMUJUh/EwLptOvfTDjldJLSErI5F0dgjUzs3v+i6Q+mvy+uq96eBM+0cSJmRlTH6t8spssldgJDsfBCAqOzfLiBdI63uovCfioEh6mCA2jYUvKNjxc1KLx9PlpEFg8gj4NgV35MnKfFrqIMxm+mEsjMmYUl9ISJ9SBhGiYlwjQWBWCNTLv9PVszdKHYwhqsNYGJOxpSarazRu5xTPZO8xZFXASDIPBHBob6pDWudLr5MSkPXG7dgCNPYcJlGT1ZUaMx5siHhMu1KOQWAGCNSzqrPVnw9JTQQOApe3LZ3KfWQeJ8bOP7sJWc0gONOFwwjUsyr+HeaFUn+zRABMJViXJVH6VatnkGxUo/TdajyWbWNd76cf3mDnxl2eY4+ErDoccpwJAvW3RcyqPix1kDkAXJ56SlBDPCYhysv0adn3L1P3Ku91v6jjAqn3qeoZs05HpoCAB28Ktq7bRq6+kBLyr6UvkUJgnMPZp4qdg59Apg+1qniEfFel70lJv9LTL5cyz0W/SvoPpOBEvTXRq7gxqW3hHqtfKpZgH69FJoZApsQ3HDAC2MTEb8l4msITy9uYgUwRs5qkIFv61yeVb+gct2Wgl0svk35K+nnpt6RHC3Bulh2TMFaeRfGv1P9FanI+Wl/G1I/YUiEwxeCrzG+e9ZUXZ3+89HekJ0kp85oDQNnRCySF3QSpZ4QmqSt07oAUcvqLopQhrWulu4mD3ik+xGdusduH1vwas2DsIv0p6f+Q0ncwCVkJhMj0EajJ6AXqjmcl7Ok4P+aUQCRA0b6dPG/rUukvS/+u9HjpTkJg8+UCeJCHmHYTX/SeozfRLiTZb3+dZY8X91g9SorUY9udyXGSCNjZJml8Q6N9NT5Odb5a+vdL3QTf2DGCqCAEgrIOzCtVvlj6nqKUa+G9kFFNJrxOfVOdhUDWjBd9ZRn/l6XM+cgMEBh7MK4DYpPV/dTYa6TcTIiD9wlAp0YjkIxJxSTFuUuk75ZeJP2YlM1yC+TEjAnhs5DxnMRkxTe5Pyb9otRjO6d+pi9bikAdwFyN+baLoPeSgvzYFJIhMGu7PqvyS6UPkvYFgiJoTVT911uUfdHb1JIQ8jUmb1U+91i1GNXUMSoECGDvzfArfROAHd/lMaQOSMjK9rDJ/Sbp06S3ltZignL/6teGyG+SsMDEuPxe1TnPOqtTyQaBaSJQzzZ+VV0wCdjxXR5D2idQbjN4gfS+0loI0JqE69eGzm+KsOrx4h4rS8jKSCSdPAI1Wf26egMpeT9nDARlGyAq7HKZ2dQTpLeUWphBEZzrmkm53X66CcKqifxfVAbV41udTjYITA+B+sp7gcyHDLhK18RggthUSiDWMwf2ZM6V1uIlX31uk/l1E5b3GEmfUjq+qdnlJnFP2zNGwEEFab1WCiH1ZzGbIinbUhPVH8u+R0stBOQYZlO2p06N7To23U1W18gAEzntb3qWWeORfBBYCQEHFMspiACCsONvkqRoG5KqiepPVOYOe4uJyuUxpsZ3aMLymF0pEE4vQLjtMeISm4LA0gjYobmz+8+kkIQdn/ymlGVobcd7VGaPysKMoV7C+vwYU2M8JGEZqw8JgJMKCG53jJjEpiCwNAJ26JP1yU9Ix0JW9VL0gOx6urSWqRCVbTbOQxAWxA5ejB37ecdKEbfZlXIMAhNHwA59qvrxWekYyKo/q/ot2eXf9HlGNcW9GGPdmrDq5fKFlT9OjdAr05MNAjdEwA59Z700FrLyLAHi/Kj0vMpsB3x1alJZ29+SsOp9vZdUaLCnFwkCs0HAZMXPM9jv2PTMisAzWV2n/K9Ij5Ei2DrFGdVB46tDa8IyXowdz7GyhKyMRNJZIFA79FvUo02TVR1475A9D6hQNrFWpyabbUlY3lwnfWpBhHGdA7FPdoBjeHsEaod+larfNFk58HhS589W3SW4a1urlyabbUVYxowfoT+qoDGXWehkBzeGD4OAZ1cvUvWQVT27obwuZWPdbfMkzzOkCCQ1p1nVwU6VQwvCMlkdUJ2n9+otxSRBYB4IOGD4TRnExL4RxLEuknI7JirKvy/17/7mOKtS9w6J8d/vprvJiudYnVRqdZ2HGkkmCMwBATs2+x0mjk2QlYOOtuuN4rnOqmrf8RgsS1j1bPRtqvC4Uqnrq9tIPghMHgE79rnqiQmj/jrcBDZkStC57auUf2RBlSWql6nl1GwTj8MyhAVuHqvfU977ettA8LN1hHRsZwTs2OwR8UNYSKlekg1JUq67XnpyF/adpIgDuCvN/+j+7pWwTFTg+OIKnm0h+KrLyW4DAnZs7hK/Qorje5ZjMhk6rYPu31egO3irU7PPus97Iaz6ovLcggyzK4/p7MFKB7cLAS8d6PXrpRDT9SUdmqRcfx10BKllW4Nur4Tliwqpfz8JZvWYGsukQWAWCDg4flm9gUBq8jChDJm6PfZgHHQsT7c56Dwmu82wTFb8P+J5UmTbcetQyHG2CDgweF6USQnicH7o1EHHH0D8aEE5QXd4z24nwjJuB4RZ7rEqjpNk3gh4uXWKuvm/pZBTvY+0LrL6pto9R4qYQLvS9h6NwyLCMll9RPCcVCDy+7cXsfR81gjUy613qKeQkwNhaKKq2/qS2j2rIJ2gK0AoMRY1YTHz9fKZe6zyHKvDeCU3cwQcEL+gftYEsk6yulpt36fgbHtmDvueu2c8TFhcTDz7vVB5X3B8K8qeK84bg8DUELCTP0SGe1a1rn0rt3e52r5bAc7BOTUch7TXmJiwTFb1PVYexyHtSN1BYKMI+MrM86PYA2FG5WXG0LMrt/MFtRmyEgi7iAnrn+g9Hhf+Tdvi/UeXkwaBWSLgq/J/Uu8IBM94HBRDpSYrHg3z4IKsg7IUk1QIGBv/+Dz/FViBk+x2IGCy4p4diIll4DqWgl7O0NbjpIgDsivl2EfAY/UkvfDj5UXOeYbcf3/KQWBWCNjRWQp+TAphedYz1KzKpOj6n6k2kZBVh8MyRxPYMp/Je4PAZBEwSTxfPYBA1rEUZEbl2RXfRiIJvA6HZY7Zr1oGrbx38giYJHgKA3eU92c+ngG1Tj2D+42CIIHnmV45lSQIBIEgcCQCJom36zSkZCJpTVB1fZ7B/WFliu2oTiUbBIJAEDiMgJeCz9apdZPVe9Wm28+y5vCYJBcEgsACBDyjua1eOyCFsLynVM+GWuZdP08QOFWKeEnalXIMAkEgCCxAwLObF+o1SMnLtJYEVddVb7L/ZLHHNiwwL6eCQBAIAh0CXoKdpiI3a0IsQ99zZUJ8eWdCZlYFhyRBIAgcBQET1qv1vnXMrryRz/8G3rzYZhuOYmpeDgJBYJsR8J7RIwVCvWQbKu+Z23Vq78wCvG3Y5nFI34NAEDgKAmy0e7P9IuUhKc9+hiIs1//Pim3ZtypAJAkCQWB3BDyzeYzeBkH5W7uhyeo1xSyT5e5W5tUgEASCgBAwYbxD+aFnVybDq9XWCQX97FsVIJIEgSCwOwKeXfFEBMiKvSXvLw0xwzJhPa2YlaVgASJJEAgCR0fAs6t36q1Dz668b/W2YhZtu/2jW5p3BIEgsNUIeHbFX2V5djXErKqum/uuHlRQd/tbPQjpfBAIAkdHoJ7dvElvH3p25RtEX1pMC1kdfYzyjiAQBAoC3ujm77KGmlW5Xu9bsdF+fGk/S8ECRJIgEASOjoBnOL+rtw49u/Le1TOLWdloP/r45B1BIAgUBDy7uqfKX5dCWEN9M2iyYlMfqZei3Zkcg0AQCAK7IODZ1a/qPZCV95e8hGuVmgRZEp4tRdx2V8oxCASBILALAt47Ok7vuVIKOXmPqRVRuR4TYZ7EsMuA5KUgEAR2RsD7Rz+htwxJVp5dfU/t3K+Y46XoztbllSAQBIJAhYBnWH+kcxCW95g8K2qVut5Xl7azFKwGIdkgEASOjoBnOPfRW3msC+TkmVAroqrrZKn5ECkSwupwyDEIzAIBk8mQnXEbP6lG+HNUCMUzrpbtQoLIG6QflNIubUWCQBAIAntCwMR0K737L6XMhLxsazm7qmdY5xTLMrsqQCQJAkFgbwiYNB6rtw9JViZBHgSIQJQmy4MncggCQWD6CHi5NnRPnjxwA+7Hy0o7lCHISBAIAkFgTwh4hsO9V5+VQiBD3Hvl2dWle7IqbwoCQSAILEDA9149Qa+ZrIb4dtAk6IfzeRm6wKScCgJBIAgsRsDLtN/SyxCW70An30pNVszgjpUintl1pRyDQBAIAkdBwKTBt4NXSyGoIWZXXg7+12JPZlcFiCRBIAjsHQETx+P1kVazqUX1eIb1iGKa2927pXlnEAgCk0HAy7bWBnuGdV6pmJlQa4GssP+j0veXypnFRYJAEJgpAkMQFmQFQbHp/kMFNxNYKTZNeNTy9VLaYxYWCQJBIAjsGQGT4Kn6BEQy1P4V9UKMp0sRt9uVcgwCQWB2CAwR5J5Nsa90UynLNJ9rBSDLQeQ90k8czGV2VWBIEgTmi8AQhGW0+JNUZMhl2mu7JrIcLDgkCQJBYAkEPJO6jT5zuRSyYjZE2kp9e8TXVOfdpciQxNu1kGMQCAKzQ8C3FTxUPTNRmWBaEZbrZbMdCVl1OOQYBGaPwFDBfoaQo242xT3ragWmb12on8zQqu7UEwSCwIgRaE1YzKKQoW5noH7P4j50sKUcgkAQCAIrIuCH9Xn51no5yP7Y7YqNrWdwK3Y9Hw8CQWAoBFrOsFzXaTL2lGJwazLxDI5bGdh0Z7blc6XJJEEgCMwVAZNMi/65rrNUGU9O8F5Ti7pdhwmQ+68iQSAIbBkCJpmW3fb/AbIcNMG0qt/1XVIqzOyqFbKpJwhMAIGWhAVBISwJkZZ1Ux8zNgjrM9LPSpEQVodDjkFgKxBoRSoQCeRxC+m9C3KeDZXiyomXmDyZ4RtSbA9hrQxrKggC00GgFWG5x7dW5vtLoTVhub4PlPpb2+4+JA0CQWCkCLQKepPJvdTPW0qZ+fhci65TH98I8pjlPPuqBaKpIwhMEIHWhMUd7shQS7Vvqe7LDrYwXBul+iRBIAiMDYHWhHWf0sHWhOX6vqj6vz5QG2Mbm9gTBIJAD4FWhOVqTykZE4zPr5q6vitKRS2Xm6vals8HgSCwJgRaEBbk4We237HY3ZpQQlhrcog0EwTGjEALwnL/jlfmDqXQmrDchmdYLe123UmDQBAYOQItAt/kBGENMcNidmU7PzdyPGNeEAgCAyJgIlilCRMWT09AIRifW6Xe+rPY+U3pF8pJ30Ravyf5IBAEZo5AC8IyRHcuGf9Ex+dXTb1/9VVVxLeEiM91pRyDQBDYCgRaEtadCmKtZ1cmpy+r/muk2OxzpckkQSAIbAMCLQnrhIEB8w+eWxPiwGan+iAQBFoh0IKwPNsZmrCubtXp1BMEgsA0EWhBWO750ITFz3IiQSAIbDECLQnr9gPjGMIaGOBUHwTGjkBLwvIMa6g9phDW2L0p9gWBgRFoSVi3HdjWENbAAKf6IDB2BFoQljfdeV7VEOIZWwhrCHRTZxCYEAKtCAtSGYqwTIjc6R4JAkFgixFYlbA8+7mpMFy1rp2GwW18p7zBBLbT+3M+CASBmSJwk0b9grCGmmGZCK9vZGuqCQJB4IYIeGJww1fanGky0Rg7YdFJgPyuNITVxnFSSxBYhEATQllUcctzYycs9zWEZSSSBoH2CLCK4bYkVkmtiYsJBw9E4OEFKz9lpRVhyZZIEAgCE0MAooJE7iJ9u5Sbv3l6cKvlIXXfXHq19NFSSIu6902KrQiLv99q/VgZVXlIbqXcMYdKyQSBINASAf4Amf8TbcUHfdua8UMrA5sZ1OupmR5AQ1g9cFIMAo0Q8JdmKy/ZevZQHxzzPSkcsbKMnbDoIJ1m6nozChKTWFfKMQgEgf0i4FgitrxUI9ZaCzHchLBWNc5rUYxpzc590I7tn0g5CASBJggMHVs1YZkz9mX4qoRFo2bmIfewaOc4DpEgEASaIzB0bMENEJVndPvuQCvCwoChCMuMPDSo+wYxHwwCE0fAseVYa90dc8MoCMudG/q3fgbV7SUNAkGgDQJDx1YzbmgxwzJk/EkEMhRL37qrPscgEAQaIzBUbJkLzA0rm92SsL66sjW7VzD0VWD31vNqEJgvAkPHVjNumBJhDf1NxnzdMT0LArsjMHRsjYqwvJH2ld0xWfnVE1euIRUEgSCwCIGhY8vcYK5YZMOezk1phnVq6ZHXxXvqYN4UBILAjgg4lhxbO75xxRdGNcNyX/66ZAyCz6+ampXvoIp4bjw3ofncqnXn80FgWxEghoglYorYQlrHlbnA3NC1ssKx5QzLRrWsswaRX5KfXPraGtgVIMxHg8AkEXAMEVP+iz6fa9Uhc4G5YeV6XeEqFZlFr1ElX5dSp8+tUm/9Wa4EfPXqtXYLu+v6kw8C24aAY4iYIraIsZYCB9AGnAA3ICvzgo3uqtvf0UZg1JdKFT63vxqP/BSsbzBPOfKllIJAEFgRAccUMdZyhmUOgBNGRVjGayjCcv2kPLMHMYF1pRyDQBBYFgHHkGNq2c8f7f2LCOtonznq661mWH5MzRAzLDph5j+t9MhgHLWDeUMQCAILEXAMOaYcYwvfvI+Trt+cAEf43D6q6z7SgrDqxj9XCq077/p8NVi547XRyQeBLUTAMeSYcoy1gsL1mROa1NuKsNz5y4tVNraJkarE9fHs6eMHaqOVraknCIwdAccTsURMIT7XlVY/uj5zgjlipZpbE9ZfFGts7ErGLfgwz3b3TW5DtbGg2ZwKArNCwLFDLBFTQ4jbMCeMkrD+l3rOPzRjbBMDC5LUxzN1jpGeWc61IttSXZIgsDUIOHaIJWKK2DLBtACB2Kc+uABOQJrwgQ3vqlz9yD0XTaeAlUnu8NnlnL/lqN6SbBAIAntAwLHzsPJex9YePrqnt7g+uABOaCatCAsDYdRrpZcV6wxKKa6c2FZA5nEY1N/yqrCygakgCEwAAWKG2CGGfPF3bLUy37EPF8AJtGkSW6mNlobyr7HIp7uk+RFb6TRfw96r1B7CKkAkCQJ7RMAxw/4VsURMteSB2gxzgbmhfm1f+SEM9QwLI5uwatUz1/eocs7gV29JNggEgV0QcMw8qrzHMbXLR5Z6ifpMUOaCpSrY7c0tCcvTwI+qwW9LDcxu7S/7msE9Z9kP5v1BIAgcgYBjyDF1xIsrFoh9OAAuQMwNXWmEx0/KJoDg2wfSVur6+ObhBCkyBDF2NecYBOaFgGOF2CGGhoxROKC5tJxhYZzr+7NiKYC0FACnTvaw7lMqdpulmCQIBIEdEHCs3FevE0PEkklsh48sfdoxbw5wm0tXtOgDTStTA+78n5bGbPyitvdzjvqZZSFnd0mOQSAILImAY6f1/VeY4Zh/X7HJnLCkiYvf3pqw3MrHlcHwJj94dKUltc0/XMoGqPe2FINAEOgh4Fhx7DiWem/bd7GOeThg9GI2vZ0svUJKB7zvRL6FsoFHPfzX2YlSxO12pRyDQBDoI+AYOUkv8KcQxJBjqUVcUodjnf0xOABxu11pxeMQDHtj2fQ1qRmWjrQUAAAYHuv6xFIxbUaCQBDYGQHHCDHDpvuQy0FiHw6gzabx35qwZN8heduh3HCZJ5Wq/3a4JlJzEJg8AlzkHSOOmSE79dYhK29dt0mQ5+z8jbTVdHNRPdR/v9IBt1uKSYJAECgIODaIlXXE5L177TYbCHekWYWqyFPAzyr/gVIx08/WQp1s6j+lVDxEX1rbnPqCwCYQcGw8VY0TM0PFI337oPQzZCTmgq7U4OiONKjqUBUYCShMQS8tZ5sbXuolYU3OIzJor+kGn+qLBIGpI+DlIDHiPd8h+uQYJ+aJRTjA54Zor2md3uB7bDEaw1t/I0GdXClIHyFF3G5XyjEIBAHHxCMFRR0z5FtpHdvEPOJ2u9LIj57pHCs7PycFmLpTrYCCyanrv0mRSYHUmZxjEBgUAcfEf1crxIpjplUMUo9jm1gn5hFzQFeawNHLTQM1xGafZ1hXCY/bFkwmB9QExjImThMBxwKxQYxALo6ZloTl2CbWEcd+V2p4HKziyug3F3tpC5BaCnUyAKdIH10q9hWlFJMEga1FwLFAbBAjxErrmCemXWcd6zo9LTG7M0X8jHQodvcU960FHrc7LbRibRBoj4BjgXsiiT/HCvlW6hkbMT7Z5aBsPyhm+JerNBRgNfDn9totxSRBYOsQcOwRE3WMtM6bBIlxxO12pYkdbTxT0iEJy6C9vuDjK8vE4Iq5QaAZAo6BN6jGdcTeLLZkDBpTxU8V4DyFbM30/qbiYWXIva4uxSRBYGsQsO8TC8SZY6N1zDmWie21LAfdsaFGEoC4gYzHpb6uNMK5IYRBQZ7bJdP7WrXYnSQIrIqAJwqOBcfGqvX2P+9YJraJ8UndLNrvjMsmRX7HdL20Ncu7Pl9FWB4+uDTuJWkpJgkCs0fAPn+meuoZkGPDsdIyJaZn93teM/6b1DnA8p5TS+Coy/eDXKg84sHrSjkGgfkjYJ9/tbpax0TrWHMME9OIY7wrTfzIVBH5CSnAmflbg+gryXVq43Qp4hleV8oxCMwXAfv6GeoiMUB8OSZax5pjmJhGHONdaeJHs+9x6scB6ZCk5VnWbxfMfMUpxSRBYLYI2NdfoR4SY46FocjqgNogphHHeFeawdFg/pr6MiSYvqJ8T+3w7yCIrzxdKccgMD8E7OP3V9eulRJjjoXWhGUiJJYRx3ZXmsnRgJ6q/nxLOiSgXl/7viy3PRMo040gcAMEPMP5I71CbDkGWpOVSZAYPq1YMdv4MhNfMDCoDJLX2P+ogDqrNXbpU5IgAAL2bR5mWft+a7KiPhPhq2hY4pjuSjM7monPUr+GALOu04R1hdpay01tMxurdGcaCHhmdWuZ+xkpMWDfr+Ohdf4hBR7HdCnOLzHAQ/9kgAHyWvvFBcZZXw3m5yrp0R4QsE//R7239vnWBEV9nl29sdhFLDuey6n5JQb48eoaIHhNPATArpuveB9YoHT7pZgkCEwWAfsyN0r74myfHzKefrQg5vYnC+BeDTcrv1sfqJl7CJB9VbioGLcVV4W9DkTeN1kEaj9+h3qxrji6tCDmGJ4sgMsYbmaGqQGaq8KQVwaT1s8UI71JWYpJgsDkELAPP0uWD01WxKb3xfxHFo7hyQG3X4PN0BevAXCDfbXaOr4YPPvNwv0OTD43egTsu7eXpZ+XQlj2cfKt1Rf8P1HdiGO3K23J0Qz9GPV3aMCp32v8lxd83f6WwJ1uzggBE9Yr1afat8kPoSbDxxUMtzJ2YGkz9ZCPcK0H0MA/owDvaXUpJgkCo0fAPvtMWYpv26drP2+Z9+zq7QWZOm7Lqe1JzNTnqcuAPOQ+Vj243KXrR2LYhu1BPT2dKgL2VX5+8x1p7dMtSaquyzH5IwU02zBVDFe229Pb15QB8NKtBq1l3vV/UO3xb7iIbehKOQaB8SFgH72ZTPuwlJiwL7eMj7ou1/8/Cxy2oRS3MzEI/FD5u1IAM6vX4LXMeyDyB6zb6XNT7LVnNjyFhFiwD7eMi7ouxyAPEfBqxLE6Rfya2ux1+YtU67oGw2v/nyo9sQ1NO5bKgkADBOyb7L0SH/iuCaUmmZZ5E+Ksn8iw37Exc/MPtQekHpSWA9Cvy4SV/az9jlo+tw4EPLNiloOvrjM2rlJ7xCTiGO1KOR76xfk/FhYMir+d6BNNy7KvIuxn+SqWgYkzjgUB+yK+iY/i+/bZlnHQr8uxRywijo2ulONBBHyLA4VLpIBo4PqAtizbAfyE0q3+2laYR8aBQO2H69q3qmPukgqGOjar08l6+ruuH3Oa+Lw8/KUyBLYjIxIENoWAfRCfxE/to/bZIVLvi3ERJwYR29GVcrwBAp5+nq9XGBTPgIYYINfpgaL8T4tFtqMUkwSBtSFg38MXF/moz7VOHWvEHmI7ulKOCxHw9JP7Tf5cyqCsY2lYX8GeVCzLgBUgkqwNAfscPmhCqn3T51qnjjFijthDHItdKccdEfA09Fy9g4FhBlTPgloPluuzY3CloW3EDtSVcgwCwyFgX8P3PNuxT9pHh0jr+LLfOwaH6+3MajZgL1O/GCQP4BADVtfpK8031OaDCqZ2pFJMEgSaI2Afw+fwPXzSvlj75xB5xxaxhjj2ulKOe0Lg+8q7bqX0E9J1DqAd5Qtq957FDjtUKSYJAs0QsG/ha/jcJnydGCPWEMdeV8pxzwiY6c/WJ0wi61ga4jC+6nxKeZ47hNixulKOQWB1BOxT+Bi+Vvse+SHVscSykxhDHHNdKcelEfCA/ht9cp2DWbf1AbV9h2K57Vm6I/lAEOghYF/Ct9Z5Y6hJ0BflXyx22Z6emSkug0A9PX2bPlgTiYEfMvWgflJtZ3m4zMjlvbshYHK4l96Eb23Kr/2cK2ytY41yZJ8I3Kh87m5KvyJlcNfx7YmJ0KTF/kI24gVCZCUETFbcnOk9K/uYfW7I1LFzjdq/R+lJloIrDekNP+xB/nG95MH0GtzlIVM7FN/gnFfMs003tDZngsBiBOwzP6yXvynFZ+1bQ/qv665vYfiHxUTbVIpJWiHgq8DzVeG6B5r2vPGPg/nmUmzKVFogRHZFAB+x/z5FefuSUxPK0KnJ8fxirW3a1fi8uD8EGHSTw+uV3yRp0bZ/xoNNXrYqGwkCRyCAb9hvf1Z5k9KmyOoNlXW2qzqVbEsETAw8p+dyKYO/7oH3HgBt+wfTyh66gpKPBAEQqGcwv6Kyyar2IZ8bMnWMXCEbbodhEsdSV8pxMATsBGeqhWulDPS6HaBu77fV/k2lSPYDOhxyPOwL/DbvlVITUu07Pjdk6vaIFWIGcQx1pRwHR8DE8FS15MFe5yY8bdKenYH7aPzsa5whU22BsKXCzMWzlzOU/4gUf2GWswkfdXwQK4hjpyvluDYEfJV4nlpkUCCPdTsE7Xoj81vKP0NqsX0uJ50/AvWYP1Pd9d9x2UdMHutI6wsqMYLU9nVnclwbAsxiPJP5TeVr8liHQ9RteI+AcywR/YiOXM0ExpaIx/rm6u8rpPaP2jd8bh2pSZLYQOp46c7kuHYETFg0/DopjnB9SdfhFHUbzPC8RGQZcLoUqZcI3Zkc54RAPb4sAT8qxS9qf6j9ZB15xwAxYaljxeeSbgAB7xfcQm2/T4pDeMDW4Rx1G0zDfWVjOfAsqcVXYJeTTh+BekwZ600uAe2H9n1igZhAHCNdKceNI+C1Ob96/5iUwTNxeCDXmdbLgAtkyx2kCFc523rwRA6TRIAx9IyFsWWM7V/12PvculL7PDHgp4zE3wTGGMUDc6KMu0yKk3gA1+UwdTv1koDfjD1basHWXPWMxnRSxsx+htWMqX8PWI937QfrytvX8X1iAKlt7c7kOCoEPEW/h6y6UoqzeCDX5Tj9dur2L5Y9Z0ktttflpONFoB4rxpCx9FjXY+xz60zd/pWyCd9Hanu7MzmOEgEP1L1l3RelOI4HdJ1OVLfF1ddLBdKXSm8jRbJM7HAY65FZipd/jBljV48lY1uP9brz9m18HZ9HHANdKcfRI+AB45u6sZAWjmxHJ3+l9GlSC4GRKbzR2HzaHw/GijFj7NB6LH1u3WlNVv5W2r4vEyNTQsADx1XnSinO5AFet2PV7dXfJHL+jVI7m7IHSSv7WyCxGenvUzE2jJHHEB9iDF3eVGpfvlK2ZGYlEOYgJi3W9Z+W4lz+2ndTjuZ2WUp4OXGd8r8rfaDU0g8cn086DALMqOoLBWPBmDA2jFk9Xh7DTaX2YXw6e1YCYU5i0uKbE9/y4AHflMPV7dZLC+z6A+kPVgOQPa4KjAGyEJX3qKge7BmD2kfqMarHbhN524UvnyhF7ONdKcfJI+AB5d6U90lxtLFM7bGlv0zk3Gulj5BaTFz1LMCvJV0OAc9ea6ICazCvSWisPoIP+z4r+/ZyCOTdo0fAG9rc/ctPFnBMpvlj2I9wkGBL/2r+Zp17tLQWnJSgqwOufj35GyIAVmDWD3CwBWOPASljMDa/wFexDd/1Hez2aZ2KzBGBeoD9g2mcwM5QO+2m833iulh28nhd3zXv8aFPmXUZjRumnk3Vr4AhWIJpPc5jI6q+b/qHzPSl9mXKkZkiUAf389RHO6y/dXF5LGmfuK6Wzb8jPU96jNSSJaOR6AicgK5noGAFZmAHhh7fRbNav7bptPZJfNVyI2eSbgcCDLgHnQebXSvFOWsH2bSz1u07qPrk9QnZfL60/nZRxYNXX8+8CNo6cHl9TuL+MZ70uT/zABswAqsaU7Ac44zKNtoX8U0/fK/2W52ObBMCOLqd+0zlr5DiLGN2Yuxj+Yoz13ssfPX+bulzpPeQ9oW+zmnfi/4QvPSJfF/AACzAxLclgB2Ygd0YtwBMVL44Ub5cim8i+Oqivh58MYftQcCbsLdTl98gtWOP2ant3CYvl0m/Ir1I+nzpw6XHS/uC49NvgoDAH3MgYBs2YutOBEUf6St9pu9gUGMydpKyrbXPvV59wCcR+2hXynHrEagd4nyhYQfC0Z0fc8pVeRF5YfPnpXxd//PSH5LyRMxFAiHUCkmsi8xMSiam2o5FttIH+kKf6Bt97I+PSaqeifbfM6Zy7WvPV38stW/63FamY76qbmJACBacG+FfcV8p5QoHEawrcNXUyuIApaK+3fTli9I/lV4i/biUx6N8TsprOwkEQl0EuMV5p5yv85RrH3PeqV832VJeJLR9V+lJ0jOkj5JCVidKec1C2x4/2sDeKYjtpi9flT5bykyfPqDuk7LbLbXjbDcSh3tvRyd47yF9udT3QHGuDhAVJyEEBLbTt779BMOXpNdIIa5PF71MKbMWzhNEfH5Iwa4TpCztTpbeR3rvohAV5+8o7ZMQdtE/Pj9Ff659iqUs+25Xlf4wNvQtUhCY4gCva/CYhrP5jvyi9AVSgoJzUw0OmX4oABwMuy03eM/VUojrc9IvS79d9Fu75HkNOa7osUpRyovy3BN1VylEdYq0T0o6dUjAH7/1e6bqw76IgD+k9W+lL5Eite91Z3IMAntAAGKyPEyZ+mtxAgenm7pCSgQMSp9qXbZvfPZ66feKkt8PTrUNzmOfSXZZu8b2/hoTfOpsKQL51j538GQOQWAZBHAiz0JuqfzLpA4ANknnEkTuU52azAgw+or2CWSZ/vPeus5+vXMipRpH5+k7GLqML+FTCD421dniwQ7kMC4E6ivfuTLtz6V2vPqK6XPbmpqU+um24uF+1z6C7+BDltq3fC5pEFgZAa6Adq6bKX++1FdMHJIZgh00abDAB7zUJo+v4DP4DoIv4VORIDAoAiYtGnmw9BKpCQqnZHbhctLtxKK//MNH8BVL7UM+lzQIDIYAV0bvbdHIs6QHpCYoz7xcTnoYm7ljUY89PoFvWLJXZSSSbgSB+kp5W1nwIul3pAQlV1mWiplxzZ+s+mOND+AL+ISl9hWfSxoE1o5Af7bFTY+vkXomYWd2OelhbOaARf+ixNjjA5bMqoxE0lEhAHHVV9FzVebuZQdliOswFsZkymmfqBhrxtyCL+ATkSAwagS4C9t3YmPoY6XvlDo4/c0RBOZzSaeBhS869TfCF2scHyO19Mff55MGgVEj0L/C/pisfY+0Jqf+Vbp+LfkjsdokHiaq2oZ3aSyfUHkgs6l6hl29lGwQmA4CfeJ6vEx/k7SeYfHNUn3VrgMj+c0RF2NSf+vHmL1R+jipJURlJJLOCoH+1fch6t0FUn4sbFIiQDLrOoyHcVln6tlUfQFhjBgrxqyW/pjWryUfBCaPgK/G9R7XaeoVX4EfkNaBCXERNARQfT759niAsS8WNb4HdJ6xOVVqYez6s2a/ljQIzBYBnL6+QvP4ladLWS7ypAMHDsHEsiTEdRgTY7Nqamzr2RTYMwaMBWNi6Y+XzycNAluFgK/Ydafvr8ILpZ+W1kG5KMDq15M/Eq9FeEBOiy4AYA3mYF8LRFXPiOvXkl8jAixPIuNBgPEgMDyTwjIeP3KOlG+jnii9q9RSv4/PZTyNzJEppAVWiDHuSt2DCdlEZ0b1Lul3ywt+X41xeSnJphCIg28K+d3bZVyszAYst1LmR6QQF/d2nSythT0vBxrnt3V8+7Oqm9QgKf956UVSiOodUn5GY2E2VX/e55OOAIFtdegRQL9nE0xA9SyBDx8vPVP696QPl54uvYW0Fu/LMPua85LGBMNsCLzqfUHw4Amon5C+V/oW6YelPKve4tlpZlNGZKRpCGukA7ODWSYvXq5nXpR/QPqDUu7xeqiUP2y4qbQWkx6p65qaD+ylD2yaf0n6fulbpR+Qflxai0ktJFWjMvL81Jx15HCu1TzGzqTDUrAW9r0eKOX5Syj3Dt1X6iBV9pD0A7b2CeedHvrQQBnIyEK+LnPe/fV7nELen5JCTB8pylM9mVnVwtLQ/e3XXb8v+ZEisC5HHGn3Z2NWHcgEIkFZy81VYL/rLOkDpPeW3l16NylLy92EuhzktGOfqfP15/26zy0iBs75vPN8bi9LV5ZyV0kPSPlW72PSD0nZl7pWWouXepxzH+rXk58YAn3nmpj5MXcHBBhXE4AJp/9W9rvuUvR+Sk1id1ceEru19DbS/oa1Tg0qzBa/If2mFHI6UBRy+qT0r4r2Z086fYjwTE4mRV6LzACBENYMBnEPXTCBOSWQ+3tgdTUsKU+UQmh3kvLv1+gdpCdIb1+Uh9MdU+nNqryyB29+ZT/pOin3PZFS/rr0K0W/qpT/O/xa0b9WCil9Ufpd6U7C8pb+eIbmdKf35/wMEPj/ZVfsh8SO+f0AAAAASUVORK5CYII=';

const ccwIconURI =
  'data:image/png;base64,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';
/**
 * String with Ev3 expected pairing pin.
 * @readonly
 */
const Ev3PairingPin = '1234';

/**
 * A maximum number of BT message sends per second, to be enforced by the rate limiter.
 * @type {number}
 */
const BTSendRateMax = 40;

/**
 * Enum for Ev3 parameter encodings of various argument and return values.
 * Found in the 'EV3 Firmware Developer Kit', section4, page 9, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 *
 * The format for these values is:
 * 0xxxxxxx for Short Format
 * 1ttt-bbb for Long Format
 *
 * @readonly
 * @enum {number}
 */
const Ev3Encoding = {
    ONE_BYTE: 0x81, // = 0b1000-001, "1 byte to follow"
    TWO_BYTES: 0x82, // = 0b1000-010, "2 bytes to follow"
    FOUR_BYTES: 0x83, // = 0b1000-011, "4 bytes to follow"
    STRING_ENCODING: 0x84,
    GLOBAL_VARIABLE_ONE_BYTE: 0xE1, // = 0b1110-001, "1 byte to follow"
    GLOBAL_CONSTANT_INDEX_0: 0x20, // = 0b00100000
    GLOBAL_VARIABLE_INDEX_0: 0x60 // = 0b01100000
};

/**
 * Enum for Ev3 direct command types.
 * Found in the 'EV3 Communication Developer Kit', section 4, page 24, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 * @readonly
 * @enum {number}
 */
const Ev3Command = {
    DIRECT_COMMAND_REPLY: 0x00,
    DIRECT_COMMAND_NO_REPLY: 0x80,
    DIRECT_REPLY: 0x02
};

/**
 * Enum for Ev3 commands opcodes.
 * Found in the 'EV3 Firmware Developer Kit', section 4, page 10, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 * @readonly
 * @enum {number}
 */
const Ev3Opcode = {
    OPOUTPUT_STEP_POWER: 0xAC,
    OPOUTPUT_STEP_SPEED: 0xAE,
    OPOUTPUT_TIME_SPEED: 0xAF,
    OPOUTPUT_STOP: 0xA3,
    OPOUTPUT_RESET: 0xA2,
    OPOUTPUT_STEP_SYNC: 0xB0,
    OPOUTPUT_TIME_SYNC: 0xB1,
    OPOUTPUT_GET_COUNT: 0xB3,
    OPSOUND: 0x94,
    OPSOUND_CMD_TONE: 1,
    OPSOUND_CMD_STOP: 0,
    OPSOUND_CMD_PLAY: 2,
    OPINPUT_DEVICE_LIST: 0x98,
    OPINPUT_READSI: 0x9D

};

/**
 * Enum for Ev3 values used as arguments to various opcodes.
 * Found in the 'EV3 Firmware Developer Kit', section4, page 10-onwards, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 * @readonly
 * @enum {number}
 */
const Ev3Args = {
    LAYER: 0, // always 0, chained EV3s not supported
    COAST: 0,
    BRAKE: 1,
    RAMP: 50, // time in milliseconds
    DO_NOT_CHANGE_TYPE: 0,
    MAX_DEVICES: 32 // 'Normally 32' from pg. 46
};

/**
 * Enum for Ev3 device type numbers.
 * Found in the 'EV3 Firmware Developer Kit', section 5, page 100, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 * @readonly
 * @enum {string}
 */
const Ev3Device = {
    29: 'color',
    30: 'ultrasonic',
    32: 'gyro',
    33: 'ir',
    16: 'touch',
    8: 'mediumMotor',
    7: 'largeMotor',
    126: 'none',
    125: 'none',
    6 : 'temperature'
};

/**
 * Enum for Ev3 device modes.
 * Found in the 'EV3 Firmware Developer Kit', section 5, page 100, at
 * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
 * @readonly
 * @enum {number}
 */


var colorNames = [ "none", "black", "blue", "green", "yellow", "red", "white"];

const Ev3Mode = {
    touch: 0, // touch
    color: 2, // ambient
    ultrasonic: 1, // inch
    ir: 0,
    none: 0
};

/**
 * Enum for Ev3 device labels used in the Scratch blocks/UI.
 * @readonly
 * @enum {string}
 */
const Ev3Label = {
    touch: 'button',
    color: 'brightness',
    ultrasonic: 'distance',
    ir : 'distance',
    temperature : 'temperature'
};

/**
 * Manage power, direction, and timers for one EV3 motor.
 */
class EV3Motor {

    /**
     * Construct a EV3 Motor instance, which could be of type 'largeMotor' or
     * 'mediumMotor'.
     *
     * @param {EV3} parent - the EV3 peripheral which owns this motor.
     * @param {int} index - the zero-based index of this motor on its parent peripheral.
     * @param {string} type - the type of motor (i.e. 'largeMotor' or 'mediumMotor').
     */
    constructor (parent, index, type) {
        /**
         * The EV3 peripheral which owns this motor.
         * @type {EV3}
         * @private
         */
        this._parent = parent;

        /**
         * The zero-based index of this motor on its parent peripheral.
         * @type {int}
         * @private
         */
        this._index = index;

        /**
         * The type of EV3 motor this could be: 'largeMotor' or 'mediumMotor'.
         * @type {string}
         * @private
         */
        this._type = type;

        /**
         * This motor's current direction: 1 for "clockwise" or -1 for "counterclockwise"
         * @type {number}
         * @private
         */
        this._direction = 1;

        /**
         * This motor's current power level, in the range [0,100].
         * @type {number}
         * @private
         */
        this._power = 100;

        /**
         * This motor's current position, in the range [0,360].
         * @type {number}
         * @private
         */
        this._position = 0;

        /**
         * An ID for the current coast command, to help override multiple coast
         * commands sent in succession.
         * @type {number}
         * @private
         */
        this._commandID = null;

        /**
         * A delay, in milliseconds, to add to coasting, to make sure that a brake
         * first takes effect if one was sent.
         * @type {number}
         * @private
         */
        this._coastDelay = 0;
    }

    /**
     * @return {string} - this motor's type: 'largeMotor' or 'mediumMotor'
     */
    get type () {
        return this._type;
    }

    /**
     * @param {string} value - this motor's new type: 'largeMotor' or 'mediumMotor'
     */
    set type (value) {
        this._type = value;
    }

    /**
     * @return {int} - this motor's current direction: 1 for "clockwise" or -1 for "counterclockwise"
     */
    get direction () {
        return this._direction;
    }

    /**
     * @param {int} value - this motor's new direction: 1 for "clockwise" or -1 for "counterclockwise"
     */
    set direction (value) {
        if (value < 0) {
            this._direction = -1;
        } else {
            this._direction = 1;
        }
    }

    /**
     * @return {int} - this motor's current power level, in the range [0,100].
     */
    get power () {
        return this._power;
    }

    /**
     * @param {int} value - this motor's new power level, in the range [0,100].
     */
    set power (value) {
        this._power = value;
    }

    /**
     * @return {int} - this motor's current position, in the range [-inf,inf].
     */
    get position () {
        return this._position;
    }

    /**
     * @param {int} array - this motor's new position, in the range [0,360].
     */
    set position (array) {
        // tachoValue from Paula
        let value = array[0] + (array[1] * 256) + (array[2] * 256 * 256) + (array[3] * 256 * 256 * 256);
        if (value > 0x7fffffff) {
            value = value - 0x100000000;
        }
        this._position = value;
    }

    /**
     * Turn this motor on for a specific duration.
     * Found in the 'EV3 Firmware Developer Kit', page 56, at
     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
     *
     * Opcode arguments:
     * (Data8) LAYER – Specify chain layer number [0 - 3]
     * (Data8) NOS – Output bit field [0x00 – 0x0F]
     * (Data8) SPEED – Power level, [-100 – 100]
     * (Data32) STEP1 – Time in milliseconds for ramp up
     * (Data32) STEP2 – Time in milliseconds for continues run
     * (Data32) STEP3 – Time in milliseconds for ramp down
     * (Data8) BRAKE - Specify break level [0: Float, 1: Break]
     *
     * @param {number} milliseconds - run the motor for this long.
     */
    turnOnFor (milliseconds) {
        if (this._power === 0) return;

        const port = this._portMask(this._index);
        let n = milliseconds;
        let speed = this._power * this._direction;
        const ramp = Ev3Args.RAMP;

        let byteCommand = [];
        byteCommand[0] = Ev3Opcode.OPOUTPUT_TIME_SPEED;

        // If speed is less than zero, make it positive and multiply the input
        // value by -1
        if (speed < 0) {
            speed = -1 * speed;
            n = -1 * n;
        }
        // If the input value is less than 0
        const dir = (n < 0) ? 0x100 - speed : speed; // step negative or positive
        n = Math.abs(n);
        // Setup motor run duration and ramping behavior
        let rampup = ramp;
        let rampdown = ramp;
        let run = n - (ramp * 2);
        if (run < 0) {
            rampup = Math.floor(n / 2);
            run = 0;
            rampdown = n - rampup;
        }
        // Generate motor command values
        const runcmd = this._runValues(run);
        byteCommand = byteCommand.concat([
            Ev3Args.LAYER,
            port,
            Ev3Encoding.ONE_BYTE,
            dir & 0xff,
            Ev3Encoding.ONE_BYTE,
            rampup
        ]).concat(runcmd.concat([
            Ev3Encoding.ONE_BYTE,
            rampdown,
            Ev3Args.BRAKE
        ]));

        const cmd = this._parent.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            byteCommand
        );

        this._parent.send(cmd);

        this.coastAfter(milliseconds);
    }
                                

    capSpeed(speed)
    {
        if (speed > 100) { speed = 100; }
        if (speed < -100) { speed = -100; }
        return speed;
    }

    turnByDegrees (degrees, speed) {
                                
        if (this._power === 0) return;

        speed = this.capSpeed(speed);

        if (degrees < 0)
        {
            degrees *= -1;
            speed *= -1;
        }
                                
        const port = this._portMask(this._index);
        let n = degrees;
        //let speed = this._power * this._direction;
        const ramp = Ev3Args.RAMP;

        let byteCommand = [];
        byteCommand[0] = Ev3Opcode.OPOUTPUT_STEP_POWER;

        // Setup motor run duration and ramping behavior
        let rampup = 0; //no ramp
        let rampdown = 0;
      
        // Generate motor command values
        const runcmd = this._runValues(n);
        byteCommand = byteCommand.concat([
            Ev3Args.LAYER,
            port,
            Ev3Encoding.ONE_BYTE,
            speed & 0xff,
            Ev3Encoding.ONE_BYTE,
            rampup,
        ]).concat(runcmd.concat([
            Ev3Encoding.ONE_BYTE,
            rampdown,
            Ev3Args.BRAKE
        ]));

        const cmd = this._parent.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            byteCommand
        );

        this._parent.send(cmd);

       // this.coastAfter(milliseconds);
    }

    /**
     * Set the motor to coast after a specified amount of time.
     * @param {number} time - the time in milliseconds.
     */
    coastAfter (time) {
        if (this._power === 0) return;

        // Set the motor command id to check before starting coast
        const commandId = uid();
        this._commandID = commandId;

        // Send coast message
        setTimeout(() => {
            // Do not send coast if another motor command changed the command id.
            if (this._commandID === commandId) {
                this.coast();
                this._commandID = null;
            }
        }, time + this._coastDelay); // add a delay so the brake takes effect
    }

    /**
     * Set the motor to coast.
     */
    coast () {
        if (this._power === 0) return;

        const cmd = this._parent.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            [
                Ev3Opcode.OPOUTPUT_STOP,
                Ev3Args.LAYER,
                this._portMask(this._index), // port output bit field
                Ev3Args.COAST
            ]
        );

        this._parent.send(cmd, false); // don't use rate limiter to ensure motor stops
    }

    brake () {
        //if (this._power === 0) return;

        const cmd = this._parent.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            [
                Ev3Opcode.OPOUTPUT_STOP,
                Ev3Args.LAYER,
                this._portMask(this._index), // port output bit field
                Ev3Args.BRAKE
            ]
        );

        this._parent.send(cmd, false); // don't use rate limiter to ensure motor stops
    }
    /**
     * Generate motor run values for a given input.
     * @param  {number} run - run input.
     * @return {array} - run values as a byte array.
     */
    _runValues (run) {
        // If run duration is less than max 16-bit integer
        if (run < 0x7fff) {
            return [
                Ev3Encoding.TWO_BYTES,
                run & 0xff,
                (run >> 8) & 0xff
            ];
        }

        // Run forever
        return [
            Ev3Encoding.FOUR_BYTES,
            run & 0xff,
            (run >> 8) & 0xff,
            (run >> 16) & 0xff,
            (run >> 24) & 0xff
        ];
    }

    /**
     * Return a port value for the EV3 that is in the format for 'output bit field'
     * as 1/2/4/8, generally needed for motor ports, instead of the typical 0/1/2/3.
     * The documentation in the 'EV3 Firmware Developer Kit' for motor port arguments
     * is sometimes mistaken, but we believe motor ports are mostly addressed this way.
     * @param {number} port - the port number to convert to an 'output bit field'.
     * @return {number} - the converted port number.
     */
    _portMask (port) {
        return Math.pow(2, port);
    }
}

class EV3 {

    constructor (runtime, extensionId) {

        /**
         * The Scratch 3.0 runtime used to trigger the green flag button.
         * @type {Runtime}
         * @private
         */
        this._runtime = runtime;
        this._runtime.on('PROJECT_STOP_ALL', this.stopAll.bind(this));

        /**
         * The id of the extension this peripheral belongs to.
         */
        this._extensionId = extensionId;

        /**
         * A list of the names of the sensors connected in ports 1,2,3,4.
         * @type {string[]}
         * @private
         */
        this._sensorPorts = [];

        /**
         * A list of the names of the motors connected in ports A,B,C,D.
         * @type {string[]}
         * @private
         */
        this._motorPorts = [];

        /**
         * The state of all sensor values.
         * @type {string[]}
         * @private
         */
        this._sensors = {
            distance: 0,
            remote: 0,
            brightness: 0,
            buttons: [0, 0, 0, 0],
            temperature: 0
        };

        /**
         * The motors which this EV3 could possibly have connected.
         * @type {string[]}
         * @private
         */
        this._motors = [null, null, null, null];

        /**
         * The polling interval, in milliseconds.
         * @type {number}
         * @private
         */
        this._pollingInterval = 150;

        /**
         * The polling interval ID.
         * @type {number}
         * @private
         */
        this._pollingIntervalID = null;

        /**
         * The counter keeping track of polling cycles.
         * @type {string[]}
         * @private
         */
        this._pollingCounter = 0;

        /**
         * The Bluetooth socket connection for reading/writing peripheral data.
         * @type {BT}
         * @private
         */
        this._bt = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        /**
         * A rate limiter utility, to help limit the rate at which we send BT messages
         * over the socket to Scratch Link to a maximum number of sends per second.
         * @type {RateLimiter}
         * @private
         */
        this._rateLimiter = new RateLimiter(BTSendRateMax);

        this.reset = this.reset.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);
        this._pollValues = this._pollValues.bind(this);
    }

    get distance () {
        let value = this._sensors.distance > 100 ? 100 : this._sensors.distance;
        value = value < 0 ? 0 : value;
        value = Math.round(100 * value) / 100;

        return value;
    }
           
    get remote () {
        return Ev3Mode.ir != 2 ? -1 : this._sensors.remote;
    }

    get temperature () {
        return this._sensors.temperature;
    }

    get brightness () {
        return this._sensors.brightness;
    }

    /**
     * Access a particular motor on this peripheral.
     * @param {int} index - the zero-based index of the desired motor.
     * @return {EV3Motor} - the EV3Motor instance, if any, at that index.
     */
    motor (index) {
        return this._motors[index];
    }

    isButtonPressed (port) {
        return this._sensors.buttons[port] === 1;
    }

    beep (freq, time) {
        const cmd = this.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            [
                Ev3Opcode.OPSOUND,
                Ev3Opcode.OPSOUND_CMD_TONE,
                Ev3Encoding.ONE_BYTE,
                2,
                Ev3Encoding.TWO_BYTES,
                freq,
                freq >> 8,
                Ev3Encoding.TWO_BYTES,
                time,
                time >> 8
            ]
        );

        this.send(cmd);
    }
                                
    _stringToByteArray(instring)
    {
        var byteArray = [];
        instring.split('').map(function (c) { var hex = c.charCodeAt(0); byteArray.push(hex) });
        byteArray.push(0);
        return byteArray;
    }
                                
    playFile (file_name) {
        let path = "/home/root/lms2012/prjs/test/" + file_name
        let byteCommand =
                [
                    Ev3Opcode.OPSOUND,
                    Ev3Opcode.OPSOUND_CMD_PLAY,
                    Ev3Encoding.ONE_BYTE,
                    100, // volume?
                    Ev3Encoding.STRING_ENCODING
                ]

        byteCommand = byteCommand.concat(this._stringToByteArray(path));

        const cmd = this.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            byteCommand
        );

        this.send(cmd);
    }

    stopAll () {
        this.stopAllMotors();
        this.stopSound();
    }

    stopSound () {
        const cmd = this.generateCommand(
            Ev3Command.DIRECT_COMMAND_NO_REPLY,
            [
                Ev3Opcode.OPSOUND,
                Ev3Opcode.OPSOUND_CMD_STOP
            ]
        );

        this.send(cmd, false); // don't use rate limiter to ensure sound stops
    }

    stopAllMotors () {
        this._motors.forEach(motor => {
            if (motor) {
                motor.coast();
            }
        });
    }

    /**
     * Called by the runtime when user wants to scan for an EV3 peripheral.
     */
    scan () {
        if (this._bt) {
            this._bt.disconnect();
        }
        this._bt = new BT(this._runtime, this._extensionId, {
            majorDeviceClass: 8,
            minorDeviceClass: 1
        }, this._onConnect, this.reset, this._onMessage);
    }

    /**
     * Called by the runtime when user wants to connect to a certain EV3 peripheral.
     * @param {number} id - the id of the peripheral to connect to.
     */
    connect (id) {
        if (this._bt) {
            this._bt.connectPeripheral(id, Ev3PairingPin);
        }
    }

    /**
     * Called by the runtime when user wants to disconnect from the EV3 peripheral.
     */
    disconnect () {
        if (this._bt) {
            this._bt.disconnect();
        }

        this.reset();
    }

    /**
     * Reset all the state and timeout/interval ids.
     */
    reset () {
        this._sensorPorts = [];
        this._motorPorts = [];
        this._sensors = {
            distance: 0,
            remote: 0,
            brightness: 0,
            temperature: 0,
            buttons: [0, 0, 0, 0]
        };
        this._motors = [null, null, null, null];

        if (this._pollingIntervalID) {
            window.clearInterval(this._pollingIntervalID);
            this._pollingIntervalID = null;
        }
    }

    /**
     * Called by the runtime to detect whether the EV3 peripheral is connected.
     * @return {boolean} - the connected state.
     */
    isConnected () {
        let connected = false;
        if (this._bt) {
            connected = this._bt.isConnected();
        }
        return connected;
    }

    /**
     * Send a message to the peripheral BT socket.
     * @param {Uint8Array} message - the message to send.
     * @param {boolean} [useLimiter=true] - if true, use the rate limiter
     * @return {Promise} - a promise result of the send operation.
     */
    send (message, useLimiter = true) {
        if (!this.isConnected()) return Promise.resolve();

        if (useLimiter) {
            if (!this._rateLimiter.okayToSend()) return Promise.resolve();
        }

        return this._bt.sendMessage({
            message: Base64Util.uint8ArrayToBase64(message),
            encoding: 'base64'
        });
    }

    /**
     * Genrates direct commands that are sent to the EV3 as a single or compounded byte arrays.
     * See 'EV3 Communication Developer Kit', section 4, page 24 at
     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits.
     *
     * Direct commands are one of two types:
     * DIRECT_COMMAND_NO_REPLY = a direct command where no reply is expected
     * DIRECT_COMMAND_REPLY = a direct command where a reply is expected, and the
     * number and length of returned values needs to be specified.
     *
     * The direct command byte array sent takes the following format:
     * Byte 0 - 1: Command size, Little Endian. Command size not including these 2 bytes
     * Byte 2 - 3: Message counter, Little Endian. Forth running counter
     * Byte 4:     Command type. Either DIRECT_COMMAND_REPLY or DIRECT_COMMAND_NO_REPLY
     * Byte 5 - 6: Reservation (allocation) of global and local variables using a compressed format
     *             (globals reserved in byte 5 and the 2 lsb of byte 6, locals reserved in the upper
     *             6 bits of byte 6) – see documentation for more details.
     * Byte 7 - n: Byte codes as a single command or compound commands (I.e. more commands composed
     *             as a small program)
     *
     * @param {number} type - the direct command type.
     * @param {string} byteCommands - a compound array of EV3 Opcode + arguments.
     * @param {number} allocation - the allocation of global and local vars needed for replies.
     * @return {array} - generated complete command byte array, with header and compounded commands.
     */
    generateCommand (type, byteCommands, allocation = 0) {

        // Header (Bytes 0 - 6)
        let command = [];
        command[2] = 0; // Message counter unused for now
        command[3] = 0; // Message counter unused for now
        command[4] = type;
        command[5] = allocation & 0xFF;
        command[6] = allocation >> 8 && 0xFF;

        // Bytecodes (Bytes 7 - n)
        command = command.concat(byteCommands);

        // Calculate command length minus first two header bytes
        const len = command.length - 2;
        command[0] = len & 0xFF;
        command[1] = len >> 8 && 0xFF;

        return command;
    }

    /**
     * When the EV3 peripheral connects, start polling for sensor and motor values.
     * @private
     */
    _onConnect () {
        this._pollingIntervalID = window.setInterval(this._pollValues, this._pollingInterval);
         var ev3 = this;
        for (let x = 0; x < 6; x++) {
            setTimeout(function() {  ev3.beep((x*300)+300,70) }, 300+(x*70));
        }
        for (let x = 0; x < 6; x++) {
            let y = 6-x;
            setTimeout(function() {  ev3.beep((y*300)+300,70) }, 700+(x*70));
        }
    }

                                
    /**
     * Poll the EV3 for sensor and motor input values, based on the list of
     * known connected sensors and motors. This is sent as many compound commands
     * in a direct command, with a reply expected.
     *
     * See 'EV3 Firmware Developer Kit', section 4.8, page 46, at
     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits
     * for a list of polling/input device commands and their arguments.
     *
     * @private
     */
    _pollValues () {
        if (!this.isConnected()) {
            window.clearInterval(this._pollingIntervalID);
            return;
        }

        const cmds = []; // compound command
        let allocation = 0;
        let sensorCount = 0;

        // Reset the list of devices every 20 counts
        if (this._pollingCounter % 20 === 0) {
            // GET DEVICE LIST
            cmds[0] = Ev3Opcode.OPINPUT_DEVICE_LIST;
            cmds[1] = Ev3Encoding.ONE_BYTE;
            cmds[2] = Ev3Args.MAX_DEVICES;
            cmds[3] = Ev3Encoding.GLOBAL_VARIABLE_INDEX_0;
            cmds[4] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;
            cmds[5] = Ev3Encoding.GLOBAL_CONSTANT_INDEX_0;

            // Command and payload lengths
            allocation = 33;

            this._updateDevices = true;
        } else {
            // GET SENSOR VALUES FOR CONNECTED SENSORS
            let index = 0;
            for (let i = 0; i < 4; i++) {
                if (this._sensorPorts[i] !== 'none') {
                    cmds[index + 0] = Ev3Opcode.OPINPUT_READSI;
                    cmds[index + 1] = Ev3Args.LAYER;
                    cmds[index + 2] = i; // PORT
                    cmds[index + 3] = Ev3Args.DO_NOT_CHANGE_TYPE;
                    cmds[index + 4] = Ev3Mode[this._sensorPorts[i]];
                    cmds[index + 5] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;
                    cmds[index + 6] = sensorCount * 4; // GLOBAL INDEX
                    index += 7;
                }
                sensorCount++;
            }

            // GET MOTOR POSITION VALUES, EVEN IF NO MOTOR PRESENT
            for (let i = 0; i < 4; i++) {
                cmds[index + 0] = Ev3Opcode.OPOUTPUT_GET_COUNT;
                cmds[index + 1] = Ev3Args.LAYER;
                cmds[index + 2] = i; // PORT (incorrectly specified as 'Output bit field' in LEGO docs)
                cmds[index + 3] = Ev3Encoding.GLOBAL_VARIABLE_ONE_BYTE;
                cmds[index + 4] = sensorCount * 4; // GLOBAL INDEX
                index += 5;
                sensorCount++;
            }

            // Command and payload lengths
            allocation = sensorCount * 4;
        }

        const cmd = this.generateCommand(
            Ev3Command.DIRECT_COMMAND_REPLY,
            cmds,
            allocation
        );

        this.send(cmd);

        this._pollingCounter++;
    }

    ///
    /// Ask Ken about this - do not touch
    ///
    getFloatResult(inputData)
    {
        var a = new ArrayBuffer(4);
        var c = new Float32Array(a);
        var arr = new Uint8Array(a);
        arr[0] = inputData[0];
        arr[1] = inputData[1];
        arr[2] = inputData[2]
        arr[3] = inputData[3]
        return c[0];
    }

    /**
     * Message handler for incoming EV3 reply messages, either a list of connected
     * devices (sensors and motors) or the values of the connected sensors and motors.
     *
     * See 'EV3 Communication Developer Kit', section 4.1, page 24 at
     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits
     * for more details on direct reply formats.
     *
     * The direct reply byte array sent takes the following format:
     * Byte 0 – 1: Reply size, Little Endian. Reply size not including these 2 bytes
     * Byte 2 – 3: Message counter, Little Endian. Equals the Direct Command
     * Byte 4:     Reply type. Either DIRECT_REPLY or DIRECT_REPLY_ERROR
     * Byte 5 - n: Resonse buffer. I.e. the content of the by the Command reserved global variables.
     *             I.e. if the command reserved 64 bytes, these bytes will be placed in the reply
     *             packet as the bytes 5 to 68.
     *
     * See 'EV3 Firmware Developer Kit', section 4.8, page 56 at
     * https://education.lego.com/en-us/support/mindstorms-ev3/developer-kits
     * for direct response buffer formats for various commands.
     *
     * @param {object} params - incoming message parameters
     * @private
     */
    _onMessage (params) {
        const message = params.message;
        const data = Base64Util.base64ToUint8Array(message);

        if (data[4] !== Ev3Command.DIRECT_REPLY) {
            return;
        }

        if (this._updateDevices) {

            // PARSE DEVICE LIST
            for (let i = 0; i < 4; i++) {
                const deviceType = Ev3Device[data[i + 5]];
                // if returned device type is null, use 'none'
                this._sensorPorts[i] = deviceType ? deviceType : 'none';
            }
            for (let i = 0; i < 4; i++) {
                const deviceType = Ev3Device[data[i + 21]];
                // if returned device type is null, use 'none'
                this._motorPorts[i] = deviceType ? deviceType : 'none';
            }
            for (let m = 0; m < 4; m++) {
                const type = this._motorPorts[m];
                if (type !== 'none' && !this._motors[m]) {
                    // add new motor if don't already have one
                    this._motors[m] = new EV3Motor(this, m, type);
                }
                if (type === 'none' && this._motors[m]) {
                    // clear old motor
                    this._motors[m] = null;
                }
            }
            this._updateDevices = false;

        // eslint-disable-next-line no-undefined
        } else if (!this._sensorPorts.includes(undefined) && !this._motorPorts.includes(undefined)) {

            // PARSE SENSOR VALUES
            let offset = 5; // start reading sensor values at byte 5
            for (let i = 0; i < 4; i++) {
                // array 2 float
                const buffer = new Uint8Array([
                    data[offset],
                    data[offset + 1],
                    data[offset + 2],
                    data[offset + 3]
                ]).buffer;
                const view = new DataView(buffer);
                const value = view.getFloat32(0, true);

                if (Ev3Label[this._sensorPorts[i]] === 'button') {
                    // Read a button value per port
                    this._sensors.buttons[i] = value ? value : 0;
                } else if (Ev3Label[this._sensorPorts[i]]) { // if valid
                    // Read brightness / distance values and set to 0 if null
                    this._sensors[Ev3Label[this._sensorPorts[i]]] = value ? value : 0;
                    if (Ev3Label[this._sensorPorts[i]] == 'distance')
                    {
                        let array = new Uint8Array([
                            data[offset],
                            data[offset + 1],
                            data[offset + 2],
                            data[offset + 3]
                        ]);

                        this._sensors.remote = this.getFloatResult(array);
                     }
                }
                offset += 4;
            }

            // PARSE MOTOR POSITION VALUES, EVEN IF NO MOTOR PRESENT
            for (let i = 0; i < 4; i++) {
                const positionArray = [
                    data[offset],
                    data[offset + 1],
                    data[offset + 2],
                    data[offset + 3]
                ];
                if (this._motors[i]) {
                    this._motors[i].position = positionArray;
                }
                offset += 4;
            }

        }
    }
}

/**
 * Enum for motor port names.
 * Note: if changed, will break compatibility with previously saved projects.
 * @readonly
 * @enum {string}
 */
const Ev3MotorMenu = ['A', 'B', 'C', 'D'];
const Ev3MotorMenuAll = ['A', 'B', 'C', 'D', 'All'];

/**
 * Enum for sensor port names.
 * Note: if changed, will break compatibility with previously saved projects.
 * @readonly
 * @enum {string}
 */
const Ev3SensorMenu = ['1', '2', '3', '4'];

class Scratch3Ev3Blocks {

    /**
     * The ID of the extension.
     * @return {string} the id
     */
    static get EXTENSION_ID () {
        return 'ev3';
    }

    /**
     * Creates a new instance of the EV3 extension.
     * @param  {object} runtime VM runtime
     * @constructor
     */
    constructor (runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        // Create a new EV3 peripheral instance
        this._peripheral = new EV3(this.runtime, Scratch3Ev3Blocks.EXTENSION_ID);

        this._playNoteForPicker = this._playNoteForPicker.bind(this);
        this.runtime.on('PLAY_NOTE', this._playNoteForPicker);
    }

    /**
     * Define the EV3 extension.
     * @return {object} Extension description.
     */
    getInfo () {
        return {
            id: Scratch3Ev3Blocks.EXTENSION_ID,
            name: 'LEGO EV3',
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'motorTurnClockwise',
                    text: formatMessage({
                        id: 'ev3.motorTurnClockwise',
                        default: 'motor [PORT] [DIR] [TIME] secs',
                        description: 'turn a motor clockwise for some time'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'motorPorts',
                            defaultValue: 0
                        },
                        TIME: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        },
                     DIR: {
                            type: ArgumentType.IMAGE,
                           dataURI: cwIconURI,
                           alt: 'CW',
                           flipRTL: true
                     }
                    }
                },
                {
                    opcode: 'motorTurnCounterClockwise',
                    text: formatMessage({
                        id: 'ev3.motorTurnCounterClockwise',
                        default: 'motor [PORT] [DIR] [TIME] secs',
                        description: 'turn a motor counter-clockwise for some time'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'motorPorts',
                            defaultValue: 0
                        },
                        TIME: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 1
                        },
                        DIR: {
                               type: ArgumentType.IMAGE,
                              dataURI: ccwIconURI,
                              alt: 'CCW',
                              flipRTL: true
                        }
                    }
                },
                     {
                         opcode: 'motorTurnClockwiseAsync',
                         text: formatMessage({
                             id: 'ev3.motorTurnClockwiseAsync',
                             default: 'motor [PORT] [DIR]',
                             description: 'turn on a motor clockwise'
                         }),
                         blockType: BlockType.COMMAND,
                         arguments: {
                             PORT: {
                                 type: ArgumentType.STRING,
                                 menu: 'motorPorts',
                                 defaultValue: 0
                             },
                             DIR: {
                                    type: ArgumentType.IMAGE,
                                   dataURI: cwIconURI,
                                   alt: 'CW',
                                   flipRTL: true
                             }
                         }
                     },
                     {
                         opcode: 'motorTurnCounterClockwiseAsync',
                         text: formatMessage({
                             id: 'ev3.motorTurnCounterClockwiseAsync',
                             default: 'motor [PORT] [DIR]',
                             description: 'turn on a motor counter-clockwise'
                         }),
                         blockType: BlockType.COMMAND,
                         arguments: {
                             PORT: {
                                 type: ArgumentType.STRING,
                                 menu: 'motorPorts',
                                 defaultValue: 0
                             },
                             DIR: {
                                    type: ArgumentType.IMAGE,
                                   dataURI: ccwIconURI,
                                   alt: 'CCW',
                                   flipRTL: true
                             }
                         }
                     },
                      {
                         opcode: 'motorTurnByDegrees',
                         text: formatMessage({
                             id: 'ev3.motorTurnDegrees',
                             default: 'motor [PORT] [DEGREES] degrees',
                             description: 'turn a motor a certain number of degrees'
                         }),
                         blockType: BlockType.COMMAND,
                         arguments: {
                             PORT: {
                                 type: ArgumentType.STRING,
                                 menu: 'motorPorts',
                                 defaultValue: 0
                             },
                             DEGREES: {
                                 type: ArgumentType.NUMBER,
                                 defaultValue: 90
                             }
                         }
                     },
                    {
                         opcode: 'motorDrive',
                         text: formatMessage({
                             id: 'ev3.motorDrive',
                             default: 'motor [PORTS] [DRIVE]',
                             description: 'tank drive for two motors'
                         }),
                         blockType: BlockType.COMMAND,
                         arguments: {
                             PORTS: {
                                 type: ArgumentType.STRING,
                                 menu: 'motorDualPorts',
                                 defaultValue: 0
                             },
                             DRIVE: {
                                 type: ArgumentType.STRING,
                                 menu: 'driveMenu',
                                 defaultValue: 0
                             }
                         }
                     },
                {
                    opcode: 'motorSetPower',
                    text: formatMessage({
                        id: 'ev3.motorSetPower',
                        default: 'motor [PORT] set power [POWER] %',
                        description: 'set a motor\'s power to some value'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'motorPorts',
                            defaultValue: 0
                        },
                        POWER: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 100
                        }
                    }
                },
                {
                    opcode: 'motorStop',
                    text: formatMessage({
                        id: 'ev3.motorStop',
                        default: 'motor [PORT] stop [HOW]',
                        description: 'stop a motor and then brake or coast'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'motorPortsWithAll',
                            defaultValue: 4
                        },
                        HOW: {
                            type: ArgumentType.STRING,
                            menu: 'howStop',
                            defaultValue:1 
                        }
                    }
                },
                {
                    opcode: 'getMotorPosition',
                    text: formatMessage({
                        id: 'ev3.getMotorPosition',
                        default: 'motor [PORT] position',
                        description: 'get the measured degrees a motor has turned'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'motorPorts',
                            defaultValue: 0
                        }
                    }
                },
                {
                    opcode: 'whenButtonPressed',
                    text: formatMessage({
                        id: 'ev3.whenButtonPressed',
                        default: 'when button [PORT] pressed',
                        description: 'when a button connected to a port is pressed'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'sensorPorts',
                            defaultValue: 0
                        }
                    }
                },
                {
                    opcode: 'setInfraredMode',
                    text: formatMessage({
                        id: 'ev3.setInfraredMode',
                        default: 'set infrared sensor to [MODE]',
                        description: 'changes the mode of the infrared sensor'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        MODE: {
                            type: ArgumentType.STRING,
                            menu: 'infraredMenu',
                            defaultValue: "distance"
                        }
                    }
                    },
                {
                    opcode: 'whenDistanceLessThan',
                    text: formatMessage({
                        id: 'ev3.whenDistanceLessThan',
                        default: 'when distance < [DISTANCE]',
                        description: 'when the value measured by the distance sensor is less than some value'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        DISTANCE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 5
                        }
                    }
                },
                {
                    opcode: 'whenBrightnessLessThan',
                    text: formatMessage({
                        id: 'ev3.whenBrightnessLessThan',
                        default: 'when brightness < [DISTANCE]',
                        description: 'when value measured by brightness sensor is less than some value'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        DISTANCE: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 50
                        }
                    }
                },
                {
                    opcode: 'buttonPressed',
                    text: formatMessage({
                        id: 'ev3.buttonPressed',
                        default: 'button [PORT] pressed?',
                        description: 'is a button on some port pressed?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        PORT: {
                            type: ArgumentType.STRING,
                            menu: 'sensorPorts',
                            defaultValue: 0
                        }
                    }
                },
                {
                    opcode: 'getIsRemoteButtonPressed',
                    text: formatMessage({
                        id: 'ev3.getIsRemoteButtonPressed',
                        default: 'remote button [CODE] pressed?',
                        description: 'is the button on the infrared remote pressed?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        CODE: {
                            type: ArgumentType.STRING,
                            menu: 'remoteButtonMenu',
                            defaultValue: 0
                        }
                    }
                },
                {
                    opcode: 'whenRemoteButtonPressed',
                    text: formatMessage({
                        id: 'ev3.whenRemoteButtonPressed',
                        default: 'when remote button [CODE] pressed',
                        description: 'when some button is pressed on the remote cnontrol'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        CODE: {
                            type: ArgumentType.STRING,
                            menu: 'remoteButtonMenu',
                            defaultValue: 0
                        }
                    }
                },
                {
                    opcode: 'getDistance',
                    text: formatMessage({
                        id: 'ev3.getDistance',
                        default: 'distance',
                        description: 'gets measured distance'
                    }),
                    blockType: BlockType.REPORTER
                },
                     
                {
                    opcode: 'getBrightness',
                    text: formatMessage({
                        id: 'ev3.getBrightness',
                        default: 'color',
                        description: 'gets measured color'
                    }),
                    blockType: BlockType.REPORTER
                },
                     {
                         opcode: 'getTemp',
                         text: formatMessage({
                             id: 'ev3.getTemp',
                             default: 'temperature',
                             description: 'gets measured distance'
                         }),
                         blockType: BlockType.REPORTER
                     },
                {
                    opcode: 'beep',
                    text: formatMessage({
                        id: 'ev3.beepNote',
                        default: 'beep note [NOTE] for [TIME] secs',
                        description: 'play some note on EV3 for some time'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        NOTE: {
                            type: ArgumentType.NOTE,
                            defaultValue: 60
                        },
                        TIME: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0.5
                        }
                    }
                },
                     {
                     opcode: 'play',
                         text: formatMessage({
                             id: 'ev3.playSound',
                             default: 'play [FILENAME]',
                             description: 'play sound file on EV3'
                         }),
                         blockType: BlockType.COMMAND,
                         arguments: {
                             FILENAME: {
                                 type: ArgumentType.STRING,
                                 menu: 'soundMenu',
                                 defaultValue: "Boing"
                             }
                         }
                     },
                     /*
                {
                    opcode: 'display',
                    text: formatMessage({
                        id: 'ev3.display',
                        default: 'display [MATRIX]',
                        description: 'show image on EV3 screen'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        MATRIX: {
                            type: ArgumentType.MATRIX,
                            defaultValue: '0101010101100010101000100'
                        }
                    }
                }
                      */
            ],
            menus: {
                motorPorts: {
                    acceptReporters: true,
                    items: this._formatMenu(Ev3MotorMenu)
                },
                motorPortsWithAll: {
                    acceptReporters: true,
                    items: this._formatMenu(Ev3MotorMenuAll)
                },
                sensorPorts: {
                    acceptReporters: true,
                    items: this._formatMenu(Ev3SensorMenu)
                },
                howStop: {
                    acceptReporters: true,
                    items: this._formatMenu(["brake", "coast"])
                },
                motorDualPorts: {
                    acceptReporters: true,
                    items: this._formatMenu(["A+D", "B+C"])
                },
                driveMenu: {
                     acceptReporters: true,
                     items: this._formatMenu(["forwards", "backwards", "right", "left"])
                 },
                soundMenu:
                {
                    acceptReporters: true,
                    items: this._stringMenu(["Backing alert", "Boing", "Cat purr", "Dog bark 1", "Dog bark 2", "Dog growl", "Dog sniff", "Dog whine", "Start up", "T-rex roar"])
                },
                infraredMenu:
                {
                    acceptReporters: true,
                    items: this._formatMenu(["distance", "remote"])
                },
                remoteButtonMenu:
                {
                    acceptReporters: true,
                    items: this._formatMenu(["Top Left", "Bottom Left", "Top Right", "Bottom Right"])
                }
            }
        };
    }

    motorTurnClockwise (args) {
        const port = Cast.toNumber(args.PORT);
        let time = Cast.toNumber(args.TIME) * 1000;
        time = MathUtil.clamp(time, 0, 15000);

        return new Promise(resolve => {
            this._forEachMotor(port, motorIndex => {
                const motor = this._peripheral.motor(motorIndex);
                if (motor) {
                    motor.direction = 1;
                    motor.turnOnFor(time);
                }
            });

            // Run for some time even when no motor is connected
            setTimeout(resolve, time);
        });
    }
                                
     display(args)
                                {}
                                
    motorTurnCounterClockwise (args) {
        const port = Cast.toNumber(args.PORT);
        let time = Cast.toNumber(args.TIME) * 1000;
        time = MathUtil.clamp(time, 0, 15000);

        return new Promise(resolve => {
            this._forEachMotor(port, motorIndex => {
                const motor = this._peripheral.motor(motorIndex);
                if (motor) {
                    motor.direction = -1;
                    motor.turnOnFor(time);
                }
            });

            // Run for some time even when no motor is connected
            setTimeout(resolve, time);
        });
    }

   motorTurnCounterClockwiseAsync (args) {
                                    
        const port = Cast.toNumber(args.PORT);
    
        this._motorTurnOn(port, -1);
    }
                                
    motorTurnClockwiseAsync (args) {
                                    
        const port = Cast.toNumber(args.PORT);
    
        this._motorTurnOn(port, 1);
    }
  
    motorDrive (args) {
                                      
          const whichPorts = Cast.toNumber(args.PORTS);
          const driveHow = Cast.toNumber(args.DRIVE);
          let ports = (whichPorts == 0) ? [0,3] : [1,2];
                                
          if (driveHow == 0) // forward
          {
             this._motorTurnOn(ports[0], 1);
             this._motorTurnOn(ports[1], 1);
          }
          else if (driveHow == 1) // backward
          {
             this._motorTurnOn(ports[0], -1);
             this._motorTurnOn(ports[1], -1);
          }
          else if (driveHow == 2) // right
          {
             this._motorTurnOn(ports[0], 1);
             this._motorTurnOn(ports[1], -1);
          }
          else if (driveHow == 3) // left
          {
             this._motorTurnOn(ports[0], -1);
             this._motorTurnOn(ports[1], 1);
          }
    }
                                
    _motorTurnOn(port, direction)
    {
        let time = 3600 * 1000;  // just say an hour
        time = MathUtil.clamp(time, 0, 15000);

        return new Promise(resolve => {
            this._forEachMotor(port, motorIndex => {
                const motor = this._peripheral.motor(motorIndex);
                if (motor) {
                    motor.direction = direction;
                    motor.turnOnFor(time);
                }
            });
            resolve();
        });
    }
                                
  motorTurnByDegrees (args)
  {
        const port = Cast.toNumber(args.PORT);
        let degrees = Cast.toNumber(args.DEGREES);
      //  time = MathUtil.clamp(time, 0, 15000);

        return new Promise(resolve => {
            this._forEachMotor(port, motorIndex => {
                const motor = this._peripheral.motor(motorIndex);
                if (motor) {
                //    motor.direction = -1;
                    motor.turnByDegrees(degrees, 100);
                }
            });
          resolve();
        });
    }
                                
    motorSetPower (args) {
        const port = Cast.toNumber(args.PORT);
        const power = MathUtil.clamp(Cast.toNumber(args.POWER), 0, 100);

        this._forEachMotor(port, motorIndex => {
            const motor = this._peripheral.motor(motorIndex);
            if (motor) {
                motor.power = power;
            }
        });
    }
                                
    motorStop (args) {
     const port = Cast.toNumber(args.PORT);
     let how = Cast.toNumber(args.HOW);
                                
    this._forEachMotor(port, motorIndex => {
        const motor = this._peripheral.motor(motorIndex);
        if (motor) {
          if (how == 0)
            {
                motor.brake();
            }
            else
            {
               motor.coast();
            }
        }
    });
     
    }

    getMotorPosition (args) {
        const port = Cast.toNumber(args.PORT);

        if (![0, 1, 2, 3].includes(port)) {
            return;
        }

        const motor = this._peripheral.motor(port);
        let position = 0;
        if (motor) {
            position = motor.position; //MathUtil.wrapClamp(motor.position, 0, 360);
        }

        return position;
    }

    whenButtonPressed (args) {
        const port = Cast.toNumber(args.PORT);

        if (![0, 1, 2, 3].includes(port)) {
            return;
        }

        return this._peripheral.isButtonPressed(port);
    }

    whenDistanceLessThan (args) {
        const distance = MathUtil.clamp(Cast.toNumber(args.DISTANCE), 0, 100);

        return this._peripheral.distance < distance;
    }

    whenBrightnessLessThan (args) {
        const brightness = MathUtil.clamp(Cast.toNumber(args.DISTANCE), 0, 100);

        return this._peripheral.brightness < brightness;
    }

    buttonPressed (args) {
        const port = Cast.toNumber(args.PORT);

        if (![0, 1, 2, 3].includes(port)) {
            return;
        }

        return this._peripheral.isButtonPressed(port);
    }

    getDistance () {
        return Ev3Mode.ir == 0 ? this._peripheral.distance : 100;
    }

    getIsRemoteButtonPressed (args) {
        /** Button to code mappings
         *  TL > 1
         *  BL > 2
         *  TR > 3
         *  BR > 4
         *  TL + TR > 5
         *  TL + BR > 6
         *  BL + TR > 7
         *  BL + BR > 8
         *  TB > 9
         *  TL + BL > 10
         *  TR + BR > 11
         */
        const buttonMap = {
            0: [0],
            1: [1],
            2: [2],
            3: [3],
            4: [4],
            5: [1, 3],
            6: [1, 4],
            7: [2, 3],
            8: [2, 4],
            9: [5],
            10: [1, 2],
            11: [3, 4] // Code 11 maps to top right (3) and bottom right (11)
        };

        let result = buttonMap[this._peripheral.remote];
        if(!result) return false;

        let ret = result.includes(parseInt(args.CODE) + 1);

        return ret;
    }

    whenRemoteButtonPressed(args) {
        return this.getIsRemoteButtonPressed(args);
    }

    setInfraredMode (args) {
        Ev3Mode.ir = args.MODE == 0 ? 0 : 2;
    }

    getTemp () {
        return this._peripheral.temperature;
    }

    getBrightness () {
        return colorNames[this._peripheral.brightness];
    }

    _playNoteForPicker (note, category) {
        if (category !== this.getInfo().name) return;
        this.beep({
            NOTE: note,
            TIME: 0.25
        });
    }

    beep (args) {
        const note = MathUtil.clamp(Cast.toNumber(args.NOTE), 47, 99); // valid EV3 sounds
        let time = Cast.toNumber(args.TIME) * 1000;
        time = MathUtil.clamp(time, 0, 3000);

        if (time === 0) {
            return; // don't send a beep time of 0
        }

        return new Promise(resolve => {
            // https://en.wikipedia.org/wiki/MIDI_tuning_standard#Frequency_values
            const freq = Math.pow(2, ((note - 69 + 12) / 12)) * 440;
            this._peripheral.beep(freq, time);

            // Run for some time even when no piezo is connected.
            setTimeout(resolve, time);
        });
    }

      play (args) {
          return new Promise(resolve => {
              this._peripheral.playFile(args.FILENAME);
              setTimeout(resolve, 1000);
          });
      }

    /**
     * Call a callback for each motor indexed by the provided motor ID.
     *
     * Note: This way of looping through motors is currently unnecessary, but could be
     * useful if an 'all motors' option is added in the future (see WeDo2 extension).
     *
     * @param {MotorID} motorID - the ID specifier.
     * @param {Function} callback - the function to call with the numeric motor index for each motor.
     * @private
     */
    _forEachMotor (motorID, callback) {
        let motors;
        switch (motorID) {
        case 0:
            motors = [0];
            break;
        case 1:
            motors = [1];
            break;
        case 2:
            motors = [2];
            break;
        case 3:
            motors = [3];
            break;
        case 4:
            motors = [0,1,2,3];
            break;
        default:
            log.warn(`Invalid motor ID: ${motorID}`);
            motors = [];
            break;
        }
        for (const index of motors) {
            callback(index);
        }
    }

    /**
     * Formats menus into a format suitable for block menus, and loading previously
     * saved projects:
     * [
     *   {
     *    text: label,
     *    value: index
     *   },
     *   {
     *    text: label,
     *    value: index
     *   },
     *   etc...
     * ]
     *
     * @param {array} menu - a menu to format.
     * @return {object} - a formatted menu as an object.
     * @private
     */
    _formatMenu (menu) {
        const m = [];
        for (let i = 0; i < menu.length; i++) {
            const obj = {};
            obj.text = menu[i];
            obj.value = i.toString();
            m.push(obj);
        }
        return m;
    }
                                  
   _stringMenu (menu) {
        const m = [];
        for (let i = 0; i < menu.length; i++) {
            const obj = {};
            obj.text = menu[i];
            obj.value = menu[i];
            m.push(obj);
        }
        return m;
    }
}

module.exports = Scratch3Ev3Blocks;
